<!DOCTYPE html>
<html lang="vi">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng VƒÉn b·∫£n Ph√°p l√Ω</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      body { font-family: Arial, sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
      .banner_home {text-align: center; padding: 0px 0px 3px 0px;font-size: 1.2rem; font-weight: bold; background: url(https://ai.phapluat.gov.vn/images/lp/bg-trongdong.png); float: left; position: relative;background-color: #002b7f; background-position: center; box-shadow: 0 4px 10px rgba(182, 182, 182, 0.18);color: #fff;position: fixed;z-index: 10;top: 0; right: 0;left: 0;}
      .banner_db{padding: 10px;}
      .bg-light_db{--bs-bg-opacity: 0.1; background-color: rgba(var(--bs-light-rgb), var(--bs-bg-opacity)) !important;width: 60%;border-radius: 10px;}
      .separator-line { border-bottom: 1px solid #ccc; margin: 0; }
      .body_home{padding-top: 133px;width: 90%;}
      .document-card { border-bottom: 1px solid #0000001a; padding: 15px; position: relative; }
      .document-card .number { position: absolute; top: 10px; left: 10px; background: #0000001a; color: white; border-radius: 10%; width: 24px; height: 24px; text-align: center; line-height: 24px; }
      .document-card .title { font-weight: bold; margin: 5px 0; }
      .document-card .date { color: #666; }
      .document-card .status { color: #888; }
      .pdf-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1050; }
      .pdf-modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; width: 80%; height: 80%; }
      .pdf-modal-content iframe { width: 100%; height: 100%; border: none; }
      .pdf-modal-close { position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer; }
      .detail-container { padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
      .detail-container .label { font-weight: bold; }
      footer { background-color:#002b7f; padding: 10px 0; text-align: center; color: #fff; margin-top: auto; }
      footer a { color:#C5C5C5;}
    </style>
  </head>
  <body>
    <div class="banner_home">
        <div class="banner_db">
          H·ªÜ TH·ªêNG VƒÇN B·∫¢N PH√ÅP L√ù<br>
          PH·ª§C V·ª§ C√îNG T√ÅC D·ª∞ B√ÅO TH·ªä TR∆Ø·ªúNG LAO ƒê·ªòNG<br>
          T·∫†I TH√ÄNH PH·ªê H·ªí CH√ç MINH
        </div>
        <header class="container-fluid py-2 bg-light_db">
          <div class="row search_website">
            <div class="col-xs-24 col-sm-24 col-md-24 ads1_home">
              <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Nh·∫≠p t·ª´ kh√≥a" onkeypress="if(event.key === 'Enter') searchData();">
                <button class="btn btn-outline-primary" onclick="searchData()">üîç</button>
              </div>
            </div>
          </div>
        </header>
    </div>


    <div class="container-fluid body_home">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="div-tab" data-bs-toggle="tab" data-bs-target="#divView" type="button" role="tab" aria-controls="divView" aria-selected="false" onclick="openTab('divView')">Danh s√°ch (Div)</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#addDocument" type="button" role="tab" aria-controls="addDocument" aria-selected="false" onclick="openTab('addDocument')">Th√™m VƒÉn b·∫£n</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="divView" role="tabpanel" aria-labelledby="div-tab">
          <div id="documentsContainer" class="mt-3"></div>
          <div id="errorMessageDiv" class="text-danger"></div>
        </div>
        <div class="tab-pane fade" id="addDocument" role="tabpanel" aria-labelledby="add-tab">
          <h3 class="mt-3">Th√™m VƒÉn b·∫£n M·ªõi</h3>
          <div class="mb-3">
            <label class="form-label">S·ªë/k√Ω hi·ªáu:</label>
            <input type="text" id="inputSoKyHieu" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Tr√≠ch y·∫øu:</label>
            <input type="text" id="inputTrichYeu" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">C∆° quan ban h√†nh:</label>
            <input type="text" id="inputCoQuan" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Ng√†y ban h√†nh:</label>
            <input type="date" id="inputNgayBanHanh" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Google Drive PDF URL:</label>
            <input type="text" id="inputPdfUrl" class="form-control" placeholder="D√°n URL Google Drive c√¥ng khai">
          </div>
          <button class="btn btn-primary" onclick="submitData()">Submit</button>
        </div>
        <div class="tab-pane fade" id="detailView" role="tabpanel" aria-labelledby="detail-tab">
          <div class="detail-container bg-white mt-3">
            <h2>Chi ti·∫øt VƒÉn b·∫£n</h2>
            <p><span class="label">S·ªë/k√Ω hi·ªáu:</span> <span id="detailSoKyHieu"></span></p>
            <p><span class="label">Tr√≠ch y·∫øu:</span> <span id="detailTrichYeu"></span></p>
            <p><span class="label">C∆° quan ban h√†nh:</span> <span id="detailCoQuan"></span></p>
            <p><span class="label">Ng√†y ban h√†nh:</span> <span id="detailNgayBanHanh"></span></p>
            <p><span class="label">PDF URL:</span> <a id="detailPdfUrl" href="#" target="_blank">Xem PDF</a></p>
            <button class="btn btn-secondary" onclick="openTab('divView')">Quay l·∫°i</button>
          </div>
        </div>
      </div>
    </div>

    <div id="pdfModal" class="pdf-modal">
      <div class="pdf-modal-content">
        <span class="pdf-modal-close" onclick="closePdfModal()">√ó</span>
        <iframe id="pdfFrame"></iframe>
      </div>
    </div>

    <footer class="mt-3">
      <p>Trung t√¢m d·ª± b√°o nhu c·∫ßu nh√¢n l·ª±c v√† th√¥ng tin th·ªã tr∆∞·ªùng lao ƒë·ªông TP. HCM</p>
      <p>Li√™n h·ªá: <a href="mailto: ttttld.sldtbxh@tphcm.gov.vn">ttttld.sldtbxh@tphcm.gov.vn</a> | Hotline:(028) 35889935</p>
    </footer>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      let allData = [];
      let currentDocumentIndex = null;

      function getDataCallback(data) {
        if (typeof data === 'string' && data.startsWith('L·ªói')) {
          showError({ message: data });
        } else {
          displayData(data);
        }
      }

      function appendDataCallback(message) {
        alert(message);
        if (!message.startsWith('L·ªói')) {
          loadScript('getData', getDataCallback);
        } else {
          showError({ message });
        }
      }

      function getPdfUrlCallback(pdfUrl) {
        if (pdfUrl && !pdfUrl.startsWith('L·ªói')) {
          const fileId = pdfUrl.match(/[-\w]{25,}/)?.[0];
          if (fileId) {
            const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            document.getElementById('pdfFrame').src = embedUrl;
            document.getElementById('pdfModal').style.display = 'block';
          } else {
            alert('URL PDF kh√¥ng h·ª£p l·ªá!');
          }
        } else {
          alert('Kh√¥ng t√¨m th·∫•y URL PDF ho·∫∑c ' + pdfUrl);
        }
      }

      function loadScript(action, callback, params = {}) {
        console.log('G·ª≠i JSONP:', { action, params });
        const script = document.createElement('script');
        const url = new URL('https://script.google.com/macros/s/AKfycbzhLIUJmGcgYhbaJkoTm4fmdbFtLkxA2R9cN9Y8YavpGStTr2atwWeKhl3uLaqBaUxw/exec');
        url.searchParams.append('callback', callback.name);
        url.searchParams.append('action', action);
        for (const [key, value] of Object.entries(params)) {
          url.searchParams.append(key, value);
        }
        script.src = url.toString();
        console.log('URL JSONP:', script.src);
        document.head.appendChild(script);
        script.onload = () => script.remove();
      }

      loadScript('getData', getDataCallback);

      function displayData(data) {
        allData = data || [];
        const errorMessageDiv = document.querySelector('#errorMessageDiv');
        errorMessageDiv.innerHTML = '';

        if (!data || !Array.isArray(data) || data.length <= 1) {
          errorMessageDiv.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu trong sheet ho·∫∑c ch·ªâ c√≥ ti√™u ƒë·ªÅ!';
          return;
        }

        if (!data[0] || data[0].length < 5) {
         errorMessageDiv.textContent = `Ti√™u ƒë·ªÅ sheet kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng! C·∫ßn √≠t nh·∫•t 5 c·ªôt: STT, S·ªë/k√Ω hi·ªáu, Tr√≠ch y·∫øu, C∆° quan ban h√†nh, Ng√†y ban h√†nh.`;
          return;
        }
        renderDivs(allData.slice(1));
      }


      function renderDivs(rows) {
        const container = document.querySelector('#documentsContainer');
        container.innerHTML = '';
        if (!rows || !rows.length) {
          const p = document.createElement('p');
          p.textContent = 'Kh√¥ng t√¨m th·∫•y vƒÉn b·∫£n!';
          container.appendChild(p);
          return;
        }
        rows.forEach((row, index) => {
          const card = document.createElement('div');
          card.className = 'document-card';
          const title = `${row[1] || ''} - ${row[2] || ''}`;
          card.innerHTML = `
            <div class="number">${index + 1}</div>
            <div class="title">${title}</div>
            <div class="date">Ng√†y ban h√†nh: ${row[4] || ''}</div>
            <!-- <div class="status">Tr·∫°ng th√°i: Ch∆∞a th√¥ng qua</div> -->
            <div class="actions mt-2">
              <button class="btn btn-primary btn-sm me-1" onclick="showDetail(${index + 1})">Xem</button>
              <button class="btn btn-info btn-sm me-1" onclick="viewPdf(${index + 1})">Xem PDF</button>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function searchData() {
        const searchTerm = document.querySelector('#searchInput').value.toLowerCase();
        const filteredData = allData.slice(1).filter(row => {
          const soKyHieu = typeof row[1] === 'string' ? row[1].toLowerCase() : '';
          const trichYeu = typeof row[2] === 'string' ? row[2].toLowerCase() : '';
          return soKyHieu.includes(searchTerm) || trichYeu.includes(searchTerm);
        });
        renderTable(filteredData);
        renderDivs(filteredData);
      }

      function submitData() {
        const dateInput = document.querySelector('#inputNgayBanHanh').value;
        let formattedDate = '';
        if (dateInput) {
          const date = new Date(dateInput);
          if (!isNaN(date)) {
            formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
          } else {
            alert('Ng√†y ban h√†nh kh√¥ng h·ª£p l·ªá!');
            return;
          }
        }

        const rowData = [
          document.querySelector('#inputSoKyHieu').value,
          document.querySelector('#inputTrichYeu').value,
          document.querySelector('#inputCoQuan').value,
          formattedDate,
          document.querySelector('#inputPdfUrl').value.trim()
        ];
        if (rowData.some(field => !field)) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng!');
          return;
        }
        loadScript('appendData', appendDataCallback, { data: JSON.stringify(rowData) });
      }

      function showError(error) {
        document.querySelector('#errorMessage').textContent = 'L·ªói: ' + (error.message || 'Kh√¥ng x√°c ƒë·ªãnh');
        document.querySelector('#errorMessageDiv').textContent = 'L·ªói: ' + (error.message || 'Kh√¥ng x√°c ƒë·ªãnh');
      }

      function openTab(tabId) {
        // Kh√¥ng c·∫ßn JS ƒë·ªÉ qu·∫£n l√Ω tab v√¨ Bootstrap x·ª≠ l√Ω qua data-bs-toggle
        // Ch·ªâ c·∫ßn ƒë·∫£m b·∫£o n·ªôi dung ƒë∆∞·ª£c render ƒë√∫ng
        if (tabId === 'tableView') {
          if (allData && allData.length > 0) {
            renderTable(allData.slice(1));
          } else {
            renderTable([]);
          }
        } else if (tabId === 'divView') {
          if (allData && allData.length > 0) {
            renderDivs(allData.slice(1));
          } else {
            renderDivs([]);
          }
        }
      }

      function showDetail(index) {
        currentDocumentIndex = index;
        if (allData && allData[index]) {
          const row = allData[index];
          document.getElementById('detailSoKyHieu').textContent = row[1] || '';
          document.getElementById('detailTrichYeu').textContent = row[2] || '';
          document.getElementById('detailCoQuan').textContent = row[3] || '';
          document.getElementById('detailNgayBanHanh').textContent = row[4] || '';
          const pdfUrl = row[5] || '';
          const pdfLink = document.getElementById('detailPdfUrl');
          pdfLink.href = pdfUrl;
          pdfLink.textContent = pdfUrl ? 'Xem PDF' : 'Kh√¥ng c√≥ PDF';
          // M·ªü tab chi ti·∫øt
          const detailTab = new bootstrap.Tab(document.querySelector('#detail-tab') || document.querySelector('#div-tab'));
          detailTab.show();
        } else {
          alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin vƒÉn b·∫£n!');
        }
      }

      function viewPdf(rowIndex) {
        loadScript('getPdfUrl', getPdfUrlCallback, { rowIndex: rowIndex - 1 });
      }

      function closePdfModal() {
        document.getElementById('pdfModal').style.display = 'none';
        document.getElementById('pdfFrame').src = '';
      }
    </script>
  </body>
</html>
